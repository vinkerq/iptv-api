#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
generate_iptv_sources.py
Integrate IPTV sources: categorize programs, merge multiple sources, add IP info, skip on timeout.
Supports multiple sources on same IP with different ports.
"""

import requests
import os
import time

# Input IP file
IP_FILE = os.path.join("dey/ip.txt")
# Output IPTV sources (plain text)
OUTPUT_FILE = "iptv_sources.txt"
# Output IPTV M3U8 file (for players)
OUTPUT_M3U8 = "iptv_sources.m3u"

# IPTV request path
REQUEST_PATH = "/iptv/live/1000.json?key=txiptv"
TIMEOUT = 10  # request timeout in seconds
RETRY = 2     # retry times if request fails
DELAY = 1     # delay between requests

# -------------------Program categories (complete, with Chinese names)-------------------
PROGRAM_CATEGORIES = {
    "Â§ÆËßÜÈ¢ëÈÅì": [
        "CCTV-1","CCTV1","CCTV-01","CCTV-2","CCTV-3","CCTV-4","CCTV-5","CCTV-5+","CCTV-6","CCTV-7",
        "CCTV-8","CCTV-9","CCTV-10","CCTV-11","CCTV-12","CCTV-13","CCTV-14","CCTV-15","CCTV-16","CCTV-17",
        "CETV-1","CETV-2","CETV-3","CETV-4","CCTV1ÁªºÂêàÈ´òÊ∏Ö","CCTV2Ë¥¢ÁªèÈ´òÊ∏Ö","CCTV3ÁªºËâ∫È´òÊ∏Ö","CCTV4ÂõΩÈôÖÈ´òÊ∏Ö",
        "CCTV5‰ΩìËÇ≤È´òÊ∏Ö","CCTV6ÁîµÂΩ±È´òÊ∏Ö","CCTV7ÂÜõ‰∫ãÈ´òÊ∏Ö","CCTV8ÁîµËßÜÂâßÈ´òÊ∏Ö","CCTV9ËÆ∞ÂΩïÈ´òÊ∏Ö",
        "CCTV10ÁßëÊïôÈ´òÊ∏Ö","CCTV11ÊàèÊõ≤È´òÊ∏Ö","CCTV12Á§æ‰ºö‰∏éÊ≥ïÈ´òÊ∏Ö","CCTV13Êñ∞ÈóªÈ´òÊ∏Ö","CCTV14Â∞ëÂÑøÈ´òÊ∏Ö",
        "CCTV15Èü≥‰πêÈ´òÊ∏Ö","CCTV16Â••ÊûóÂåπÂÖãÈ´òÊ∏Ö","CCTV17ÂÜú‰∏öÂÜúÊùëÈ´òÊ∏Ö","CCTV5+‰ΩìËÇ≤ËµõËßÜÈ´òÊ∏Ö",
    ],
    "Âç´ËßÜÈ¢ëÈÅì": [
        "Âπø‰∏úÂç´ËßÜ","È¶ôÊ∏ØÂç´ËßÜ","ÊµôÊ±üÂç´ËßÜ","ÊπñÂçóÂç´ËßÜ","Âåó‰∫¨Âç´ËßÜ","ÊπñÂåóÂç´ËßÜ","ÈªëÈæôÊ±üÂç´ËßÜ","ÂÆâÂæΩÂç´ËßÜ",
        "ÈáçÂ∫ÜÂç´ËßÜ","‰∏úÊñπÂç´ËßÜ","‰∏úÂçóÂç´ËßÜ","ÁîòËÇÉÂç´ËßÜ","ÂπøË•øÂç´ËßÜ","Ë¥µÂ∑ûÂç´ËßÜ","Êµ∑ÂçóÂç´ËßÜ","Ê≤≥ÂåóÂç´ËßÜ",
        "Ê≤≥ÂçóÂç´ËßÜ","ÂêâÊûóÂç´ËßÜ","Ê±üËãèÂç´ËßÜ","Ê±üË•øÂç´ËßÜ","ËæΩÂÆÅÂç´ËßÜ","ÂÜÖËíôÂè§Âç´ËßÜ","ÂÆÅÂ§èÂç´ËßÜ","ÈùíÊµ∑Âç´ËßÜ",
        "Â±±‰∏úÂç´ËßÜ","Â±±Ë•øÂç´ËßÜ","ÈôïË•øÂç´ËßÜ","ÂõõÂ∑ùÂç´ËßÜ","Ê∑±Âú≥Âç´ËßÜ","‰∏âÊ≤ôÂç´ËßÜ","Â§©Ê¥•Âç´ËßÜ","Ë•øËóèÂç´ËßÜ",
        "Êñ∞ÁñÜÂç´ËßÜ","‰∫ëÂçóÂç´ËßÜ",
        "Âπø‰∏úÂç´ËßÜÈ´òÊ∏Ö","È¶ôÊ∏ØÂç´ËßÜÈ´òÊ∏Ö","ÊµôÊ±üÂç´ËßÜÈ´òÊ∏Ö","ÊπñÂçóÂç´ËßÜÈ´òÊ∏Ö","Âåó‰∫¨Âç´ËßÜÈ´òÊ∏Ö","ÊπñÂåóÂç´ËßÜÈ´òÊ∏Ö","ÈªëÈæôÊ±üÂç´ËßÜÈ´òÊ∏Ö","ÂÆâÂæΩÂç´ËßÜÈ´òÊ∏Ö",
        "ÈáçÂ∫ÜÂç´ËßÜÈ´òÊ∏Ö","‰∏úÊñπÂç´ËßÜÈ´òÊ∏Ö","‰∏úÂçóÂç´ËßÜÈ´òÊ∏Ö","ÁîòËÇÉÂç´ËßÜÈ´òÊ∏Ö","ÂπøË•øÂç´ËßÜÈ´òÊ∏Ö","Ë¥µÂ∑ûÂç´ËßÜÈ´òÊ∏Ö","Êµ∑ÂçóÂç´ËßÜÈ´òÊ∏Ö","Ê≤≥ÂåóÂç´ËßÜÈ´òÊ∏Ö",
        "Ê≤≥ÂçóÂç´ËßÜÈ´òÊ∏Ö","ÂêâÊûóÂç´ËßÜÈ´òÊ∏Ö","Ê±üËãèÂç´ËßÜÈ´òÊ∏Ö","Ê±üË•øÂç´ËßÜÈ´òÊ∏Ö","ËæΩÂÆÅÂç´ËßÜÈ´òÊ∏Ö","ÂÜÖËíôÂè§Âç´ËßÜÈ´òÊ∏Ö","ÂÆÅÂ§èÂç´ËßÜÈ´òÊ∏Ö","ÈùíÊµ∑Âç´ËßÜÈ´òÊ∏Ö",
        "Â±±‰∏úÂç´ËßÜÈ´òÊ∏Ö","Â±±Ë•øÂç´ËßÜÈ´òÊ∏Ö","ÈôïË•øÂç´ËßÜÈ´òÊ∏Ö","ÂõõÂ∑ùÂç´ËßÜÈ´òÊ∏Ö","Ê∑±Âú≥Âç´ËßÜÈ´òÊ∏Ö","‰∏âÊ≤ôÂç´ËßÜÈ´òÊ∏Ö","Â§©Ê¥•Âç´ËßÜÈ´òÊ∏Ö","Ë•øËóèÂç´ËßÜÈ´òÊ∏Ö",
        "Êñ∞ÁñÜÂç´ËßÜÈ´òÊ∏Ö","‰∫ëÂçóÂç´ËßÜÈ´òÊ∏Ö"
    ],
    "Âπø‰∏úÈ¢ëÈÅì": [
        "Âπø‰∏úÁè†Ê±ü","Âπø‰∏ú‰ΩìËÇ≤","Âπø‰∏úÊñ∞Èóª","Âπø‰∏úÂç´ËßÜ","Âπø‰∏úÊ∞ëÁîü","Â§ßÊπæÂå∫Âç´ËßÜ","ÂπøÂ∑ûÁªºÂêà",
        "ÂπøÂ∑ûÂΩ±ËßÜ","ÂπøÂ∑ûÁ´ûËµõ","Ê±üÈó®ÁªºÂêà","Ê±üÈó®‰æ®‰π°ÁîüÊ¥ª","‰ΩõÂ±±ÁªºÂêà","Ê∑±Âú≥Âç´ËßÜ","Ê±ïÂ§¥ÁªºÂêà",
        "Ê±ïÂ§¥ÁªèÊµé","Ê±ïÂ§¥ÊñáÊóÖ","ËåÇÂêçÁªºÂêà","ËåÇÂêçÂÖ¨ÂÖ±",
        "Âπø‰∏úÁè†Ê±üÈ´òÊ∏Ö","Âπø‰∏ú‰ΩìËÇ≤È´òÊ∏Ö","Âπø‰∏úÊñ∞ÈóªÈ´òÊ∏Ö","Âπø‰∏úÂç´ËßÜÈ´òÊ∏Ö","Âπø‰∏úÊ∞ëÁîüÈ´òÊ∏Ö","Â§ßÊπæÂå∫Âç´ËßÜÈ´òÊ∏Ö","ÂπøÂ∑ûÁªºÂêàÈ´òÊ∏Ö",
        "ÂπøÂ∑ûÂΩ±ËßÜÈ´òÊ∏Ö","ÂπøÂ∑ûÁ´ûËµõÈ´òÊ∏Ö","Ê±üÈó®ÁªºÂêàÈ´òÊ∏Ö","Ê±üÈó®‰æ®‰π°ÁîüÊ¥ªÈ´òÊ∏Ö","‰ΩõÂ±±ÁªºÂêàÈ´òÊ∏Ö","Ê∑±Âú≥Âç´ËßÜÈ´òÊ∏Ö","Ê±ïÂ§¥ÁªºÂêàÈ´òÊ∏Ö",
        "Ê±ïÂ§¥ÁªèÊµéÈ´òÊ∏Ö","Ê±ïÂ§¥ÊñáÊóÖÈ´òÊ∏Ö","ËåÇÂêçÁªºÂêàÈ´òÊ∏Ö","ËåÇÂêçÂÖ¨ÂÖ±È´òÊ∏Ö"
    ],
    "ÊµôÊ±üÈ¢ëÈÅì": [
        "ÊµôÊ±üÈí±Ê±ü","ÊµôÊ±üÈí±Ê±üÈÉΩÂ∏Ç","ÊµôÊ±üÈí±Ê±üÂè∞","ÊµôÊ±üÁîüÊ¥ª","ÊµôÊ±üÁªèÊµéÁîüÊ¥ª","ÊµôÊ±üÊïôËÇ≤","ÊµôÊ±üÊ∞ëÁîü",
        "ÊµôÊ±üÊñ∞Èóª","ÊµôÊ±üÂ∞ëÂÑø"
    ],
    "Âåó‰∫¨È¢ëÈÅì": [
        "Âåó‰∫¨Âç°ÈÖ∑Â∞ëÂÑø","Âåó‰∫¨ÂΩ±Èô¢","Âåó‰∫¨Êñ∞Èóª","Âåó‰∫¨ÁîüÊ¥ª","Âåó‰∫¨ÁßëÊïô","Âåó‰∫¨Ë¥¢Áªè","Âåó‰∫¨ÈùíÂπ¥",
        "BTVÁ∫™ÂÆû","Ê∏ÖÂçéÂ§ßÂ≠¶ÁîµËßÜÂè∞","Áü≥ÊôØÂ±±ÊúâÁ∫ø","ÈÄöÂ∑ûÁîµËßÜÂè∞"
    ],
    "ËæΩÂÆÅÈ¢ëÈÅì": [
        "ÊúùÈò≥ÊïôËÇ≤","ÊúùÈò≥Êñ∞ÈóªÁªºÂêà","ËæΩÂÆÅÂåóÊñπ","ËæΩÂÆÅÂΩ±ËßÜÂâß","ËæΩÂÆÅÊïôËÇ≤ÈùíÂ∞ë","ËæΩÂÆÅÁîüÊ¥ª",
        "ËæΩÂÆÅÁªèÊµé","ËæΩÂÆÅÈÉΩÂ∏Ç","Èî¶Â∑û‰∏ÄÂ•óÊñ∞ÈóªÁªºÂêà","Èî¶Â∑û‰∫åÂ•óÊïôËÇ≤"
    ],
    "ÊπñÂçóÈ¢ëÈÅì": [
        "ÊπñÂçóÈÉΩÂ∏Ç","ÊπñÂçóËßÜÂâß","ÊπñÂçóÁªèËßÜ","ÊπñÂçóÁîµËßÜÂâß","ÊπñÂçóÁîµÂΩ±","ÊπñÂçóÁà±Êôö","ÊπñÂçóÊïôËÇ≤",
        "ÊπñÂçóÂ®±‰πê","ÊπñÂçóÂõΩÈôÖ","ÊπñÂçóÂÖ¨ÂÖ±","ÈáëÈπ∞Á∫™ÂÆû","ÊπñÂçóÈáëÈπ∞Á∫™ÂÆû","ÈïøÊ≤ôÊñ∞ÈóªÁªºÂêà","ÈïøÊ≤ôÊñ∞Èóª",
        "ÈïøÊ≤ôÊîøÊ≥ï","ÈïøÊ≤ôÂΩ±ËßÜ","ÈïøÊ≤ôÂ•≥ÊÄß","ÈÜ¥ÈôµÁªºÂêà","Ë°°Èò≥Êñ∞ÈóªÁªºÂêà","Ë°°Èò≥ÂÖ¨ÂÖ±","Ëå∂ÈôµÊñ∞ÈóªÁªºÂêà",
        "ÁõäÈò≥Êñ∞ÈóªÁªºÂêà","ÁõäÈò≥ÊïôËÇ≤","ÁõäÈò≥ÂÖ¨ÂÖ±","ÊπòÊΩ≠Êñ∞ÈóªÁªºÂêà","ÊπòÊΩ≠ÂéøÁªºÂêà","ÊπòÊΩ≠ÂÖ¨ÂÖ±",
        "ÊπòÊΩ≠ÂÖ¨ÂÖ±ÈÉΩÂ∏Ç","Ê¥™Ê±üÂ∏ÇÁªºÂêà","Ê≥∏Ê∫™ÁîµËßÜÂè∞","Ê±®ÁΩóÊñ∞ÈóªÁªºÂêà","Ê±üÂçéÁªºÂêà","Ê±ùÂüéÁªºÂêà",
        "Ê∞∏È°∫ÁªºÂêà","Ê°ëÊ§çÊñ∞ÈóªÁªºÂêà","Êñ∞ÂåñÊñ∞ÈóªÁªºÂêà","Â±àÂéüÁªºÂêà","ÂÆÅ‰π°ÁªºÂêà","Â®ÑÂ∫ïÁªºÂêà","‰øùÈùñÊó∂Êîø",
        "‰∫ëÊ∫™Êñ∞ÈóªÁªºÂêà"
    ],
    "ÊπñÂåóÈ¢ëÈÅì": [
        "ÊπñÂåóÊñ∞ÈóªÁªºÂêà","ÊπñÂåóÁªºÂêà","ÊπñÂåóÁªèËßÜ","ÊπñÂåóÁîüÊ¥ª","ÊπñÂåóÊïôËÇ≤","ÊπñÂåóÂΩ±ËßÜ","ÊπñÂåóÂÖ¨ÂÖ±Êñ∞Èóª",
        "ÊπñÂåóÂÖ¨ÂÖ±","ÊπñÂåóÁªèÊµé","ÊπñÂåóÂûÑ‰∏ä","Ê≠¶Ê±â‰∏ÄÂè∞Êñ∞ÈóªÁªºÂêà","Ê≠¶Ê±â‰∫åÂè∞ÁîµËßÜÂâß","Ê≠¶Ê±â‰∏âÂè∞ÁßëÊäÄÁîüÊ¥ª",
        "Ê≠¶Ê±âÂõõÂè∞ÁªèÊµé","Ê≠¶Ê±â‰∫îÂè∞Êñá‰Ωì","Ê≠¶Ê±âÂÖ≠Âè∞Â§ñËØ≠","Ê≠¶Ê±â1Êñ∞ÈóªÁªºÂêà","Ê≠¶Ê±â2ÁîµËßÜÂâß","Ê≠¶Ê±â3ÁßëÊäÄÁîüÊ¥ª",
        "Ê≠¶Ê±âÊïôËÇ≤","ÊπñÂåóÊ≠¶Ê±âÊïôËÇ≤","Ê≠¶Ê±âÁªèÊµé","Ê≠¶Ê±âÊñ∞ÈóªÁªºÂêà","Ê≠¶Ê±âÊñá‰Ωì","Ê≠¶Ê±âÂ§ñËØ≠","Ê±üÂ§èÁªèÊµéÁîüÊ¥ª",
        "Ê±üÂ§èÊñ∞ÈóªÁªºÂêà","Âª∫ÂßãÁªºÂêà","Â¥áÈò≥Êñ∞ÈóªÁªºÂêà","ÂçÅÂ†∞Êñ∞Èóª","ÂçÅÂ†∞ÂÖ¨ÂÖ±","‰øùÂ∫∑Êñ∞ÈóªÁªºÂêà",
        "‰ªôÊ°ÉÁîüÊ¥ªÊñá‰Ωì","‰ªôÊ°ÉÊñ∞ÈóªÁªºÂêà","È∫ªÂüéÁªºÂêà","ÈÉßÈò≥Êñ∞ÈóªÁªºÂêà","ËçÜÈó®Êñ∞ÈóªÁªºÂêà","‰∫ëÊ¢¶ÁªºÂêà",
        "‰∫ëÊ¢¶ÂÖöÂª∫ÂÜú‰∏ö","Ê≠¶Ê±âÁîüÊ¥ª","Ê≠¶Ê±âÊñ∞Èóª","Ê≠¶Ê±âÁªèÊµé","ËçÜÈó®Êñ∞ÈóªÁªºÂêà","Â¥áÈò≥ÁªºÂêà",
        "ÂçÅÂ†∞Êñ∞Èóª","ÊΩúÊ±üÁªºÂêà","ÊπñÂåóÁîüÊ¥ª","ÊπñÂåóÊïôËÇ≤","ÊπñÂåóÂΩ±ËßÜ","ÊπñÂåóÂûÑ‰∏ä"
    ],
    "ÂπøË•øÈ¢ëÈÅì": [
        "‰πê‰∏öÁªºÂêà","Âáå‰∫ëÁªºÂêà","Âá≠Á••ÁªºÂêà","ÂåóÊµ∑Êñ∞ÈóªÁªºÂêà","ÂåóÊµ∑ÁªèÊµéÁßëÊïô","ÂçóÂÆÅÂÖ¨ÂÖ±","ÂçóÂÆÅÂΩ±Â®±‰πê",
        "ÂçóÂÆÅÊñ∞ÈóªÁªºÂêà","ÂçóÂÆÅÈÉΩÂ∏ÇÁîüÊ¥ª","ÂçöÁôΩÁªºÂêà","Â§©Á≠âÁªºÂêà","ÂÆæÈò≥ÁªºÂêà","Â≤ëÊ∫™ÁªºÂêà","Â¥áÂ∑¶ÁªºÂêà",
        "Â∑¥È©¨ÁªºÂêà","Êò≠Âπ≥ÁªºÂêà","Êù•ÂÆæÁªºÂêà","Ê°ÇÂπ≥ÁªºÂêà","ÁÅåÈò≥Êñ∞ÈóªÁªºÂêà","ÁÅµÂ∑ùÁªºÂêà","Áî∞‰∏úÁªºÂêà",
        "Áî∞Èò≥ÁªºÂêà","ÁΩóÂüéÁªºÂêà","ËûçÊ∞¥ÁªºÂêà","Ë•øÊûóÁªºÂêà","Ë¥∫Â∑ûÁªºÂêà","ËµÑÊ∫êÁîµËßÜÂè∞","ÈÇ£Âù°ÁªºÂêà",
        "ÈÉΩÂÆâÁªºÂêà","Èí¶Â∑ûÂÖ¨ÂÖ±","Èí¶Â∑ûÁªºÂêà","ÈùñË•øÁªºÂêà","ÈæôÂ∑ûÁªºÂêà","ÂπøË•øÊñ∞Èóª","ÁΩóÂüéÁªºÂêà",
        "ÂåóÊµ∑Êñ∞Èóª","Ê°ÇÊûóÊñ∞Èóª","ÂπøË•øË¥∫Â∑û","ÂπøË•øÂõΩÈôÖ","ÂπøË•ø‰πêÊÄùË¥≠","ÂçóÂÆÅÊñ∞ÈóªÁªºÂêà","ÂçóÂÆÅÈÉΩÂ∏ÇÁîüÊ¥ª",
        "ÂçóÂÆÅÂΩ±ËßÜÂ®±‰πê","ÂçóÂÆÅÂÖ¨ÂÖ±"
    ],
    "Â§©Ê¥•È¢ëÈÅì": [
        "ÂÆÅÊ≤≥Êñ∞Èóª","Êª®Êµ∑Êñ∞Èóª","Êª®Êµ∑ÁªºËâ∫","Êª®Êµ∑ÂΩ±Èô¢","Ê¥•Âçó‰∏ÄÂ•ó","Ê≠¶Ê∏ÖÁªºÂêà","Â§©Ê¥•ÈÉΩÂ∏Ç","Â§©Ê¥•Êñ∞Èóª",
        "Â§©Ê¥•ÊñáËâ∫","Â§©Ê¥•Âç´ËßÜ"
    ],
    "Á¶èÂª∫È¢ëÈÅì": [
        "‰∏âÊòéÂÖ¨ÂÖ±","‰∏âÊòéÊñ∞ÈóªÁªºÂêà","‰∫ëÈúÑÁªºÂêà","Âé¶Èó®Âç´ËßÜ","ÂÆÅÂåñÁîµËßÜ‰∏ÄÂ•ó","Â∞Ü‰πêÁªºÂêà","Âª∫ÂÆÅÁªºÂêà",
        "Âæ∑ÂåñÊñ∞ÈóªÁªºÂêà","Êñ∞ÁΩóÁîµËßÜ‰∏ÄÂ•ó","ÊôãÊ±üÁîµËßÜÂè∞","Ê∞∏ÂÆâÁªºÂêà","Ê∞∏Ê≥∞ÁªºÂêà","Ê≥∞ÂÆÅÊñ∞Èóª","Êº≥Â∑ûÊñ∞ÈóªÁªºÂêà",
        "Êº≥Êµ¶ÁªºÂêà","Áü≥ÁãÆÁªºÂêà","Á¶èÂ∑ûÂ∞ëÂÑø","Á¶èÂ∑ûÂΩ±Èô¢","Á¶èÂ∑ûÁîüÊ¥ª","Á¶èÂ∑ûÁªºÂêà","ÈúûÊµ¶ÁªºÂêà","ÈæôÂ≤©ÂÖ¨ÂÖ±",
        "ÈæôÂ≤©Êñ∞ÈóªÁªºÂêà","Á¶èÂª∫Êñá‰Ωì","Á¶èÂª∫Êñ∞Èóª","Á¶èÂª∫ÁîµËßÜÂâß","Á¶èÂª∫ÁªèÊµé","Á¶èÂª∫ÁªºÂêà","Á¶èÂª∫ÂÖ¨ÂÖ±",
        "Á¶èÂª∫ÂΩ±Ââß","Á¶èÂª∫ÊïôËÇ≤","Á¶èÂª∫ÁîüÊ¥ª"
    ],
    "Ê∏ØÊæ≥Âè∞È¢ëÈÅì": [
        "È¶ôÊ∏ØÂç´ËßÜ","Êæ≥Èó®Âç´ËßÜ","Âá§Âá∞Âç´ËßÜ‰∏≠ÊñáÂè∞","Âá§Âá∞Âç´ËßÜËµÑËÆØÂè∞","‰∏úÊ£ÆÊñ∞ÈóªÂè∞","‰∏úÊ£ÆË¥¢ÁªèÂè∞","‰∏≠Â§©ÁªºÂêàÂè∞","‰∏≠ËßÜÁªèÊµéÂè∞",
        "Âè∞ÊπæÂÖ¨ÂÖ±ÁîµËßÜ","Âè∞ÊπæÂç´ËßÜ‰∏≠ÊñáÂè∞","Âè∞ÊπæÊ∞ëËßÜÊñ∞ÈóªÂè∞","Âè∞Êπæ‰∏≠ËßÜ","Âè∞ÊπæÂçéËßÜ"
    ],
    "ÁîµÂΩ±Âè∞": [
        "CCTV6ÁîµÂΩ±","ÁîµÂΩ±È¢ëÈÅì","ÂçéÂ§èÁîµÂΩ±","ÈáëÈπ∞ÁîµÂΩ±","Âåó‰∫¨ÁîµÂΩ±","‰∏úÊñπÁîµÂΩ±","ÂçóÊñπÁîµÂΩ±","ÁîµÂΩ±‰∏ñÁïå",
        "ÁªèÂÖ∏ÁîµÂΩ±","ÁªèÂÖ∏ÂΩ±ËßÜ","‰∫îÊòüÁîµÂΩ±","‰∫îÊòüÈ´òÊ∏ÖÁîµÂΩ±"
    ],
    "Âí™ÂíïÁõ¥Êí≠": [
        "Âí™ÂíïÁõ¥Êí≠1","Âí™ÂíïÁõ¥Êí≠2","Âí™ÂíïÁõ¥Êí≠3","Âí™ÂíïÁõ¥Êí≠4","Âí™ÂíïÁõ¥Êí≠5"
    ],
    "Âä®Áîª/Â∞ëÂÑø": [
        "Âç°ÈÖ∑Â∞ëÂÑø","Âä®Êº´‰∏ñÁïå","Â∞ëÂÑøÈ¢ëÈÅì","Â••È£ûÂä®Êº´","Ëø™Â£´Â∞ºÈ¢ëÈÅì","CCTV14Â∞ëÂÑø","CCTV15Èü≥‰πê"
    ],
    "ÁªèÂÖ∏ÂâßÂú∫": [
        "CCTV8ÁîµËßÜÂâß","ÁªèÂÖ∏ÁîµËßÜÂâß","ÈáëÈπ∞ÁîµËßÜÂâß","ÂΩ±ËßÜÁªèÂÖ∏","ÁîµÂΩ±ÁªèÂÖ∏","ÁîµËßÜÂâßÈ¢ëÈÅì"
    ]
}

# -------------------Read IP list-------------------
def read_ip_list(file_path):
    if not os.path.exists(file_path):
        raise FileNotFoundError(f"IP file not found: {file_path}")
    with open(file_path, "r", encoding="utf-8") as f:
        return [line.strip() for line in f if line.strip()]

# -------------------Get IP info (city + ISP)-------------------
def get_ip_info(ip):
    try:
        resp = requests.get(f"https://ip.taobao.com/outGetIpInfo?ip={ip}&accessKey=alibaba-inc", timeout=5)
        data = resp.json()
        if data.get("code") == 0 and data.get("data"):
            city = data["data"].get("city", "Unknown")
            isp = data["data"].get("isp", "Unknown")
            return f"{city},{isp}"
    except:
        pass
    return "Unknown,Unknown"

# -------------------Fetch IPTV JSON-------------------
def fetch_json(ipport):
    url = f"http://{ipport}{REQUEST_PATH}"
    for attempt in range(RETRY+1):
        try:
            resp = requests.get(url, timeout=TIMEOUT)
            resp.raise_for_status()
            return resp.json()
        except Exception as e:
            print(f"[Error] Request failed: {url} -> {e} (retry {attempt}/{RETRY})")
            time.sleep(DELAY)
    return None

# -------------------Parse JSON data-------------------
def parse_data(json_data, ipport, ip_info):
    sources = {}
    if not json_data or "data" not in json_data:
        return sources
    for item in json_data["data"]:
        name = item.get("name", "Êú™Áü•")
        url_path = item.get("url", "")
        if url_path:
            full_url = f"http://{ipport}{url_path} ({ip_info})"
            if name not in sources:
                sources[name] = [full_url]
            else:
                sources[name].append(full_url)
    return sources

# -------------------Merge multiple sources-------------------
def merge_sources(all_sources, new_sources):
    for name, urls in new_sources.items():
        if name not in all_sources:
            all_sources[name] = urls
        else:
            all_sources[name].extend(urls)

# -------------------Save plain text-------------------
def save_txt(all_sources, file_path):
    with open(file_path, "w", encoding="utf-8") as f:
        for category, names in PROGRAM_CATEGORIES.items():
            f.write(f"üì∫{category},#genre#\n")
            for name in names:
                if name in all_sources:
                    for url in all_sources[name]:
                        f.write(f"{name},{url}\n")

# -------------------Save M3U8 playlist-------------------
def save_m3u(all_sources, file_path):
    with open(file_path, "w", encoding="utf-8") as f:
        f.write("#EXTM3U\n")
        for category, names in PROGRAM_CATEGORIES.items():
            for name in names:
                if name in all_sources:
                    urls = all_sources[name]
                    for i, url in enumerate(urls):
                        f.write(f"#EXTINF:-1,{name} [Ê∫ê{i+1}]\n{url}\n")

# -------------------Main-------------------
def main():
    try:
        ip_list = read_ip_list(IP_FILE)
    except Exception as e:
        print(f"[Error] {e}")
        return

    all_sources = {}

    for ipport in ip_list:
        ip = ipport.split(":")[0]
        ip_info = get_ip_info(ip)
        print(f"Fetching: {ipport} ({ip_info})")
        json_data = fetch_json(ipport)
        sources = parse_data(json_data, ipport, ip_info)
        if sources:
            merge_sources(all_sources, sources)
            print(f"Got {len(sources)} programs")
        else:
            print(f"No data for: {ipport}")

    if all_sources:
        save_txt(all_sources, OUTPUT_FILE)
        save_m3u(all_sources, OUTPUT_M3U8)
        print(f"\nCompleted. Files generated:\n- {OUTPUT_FILE}\n- {OUTPUT_M3U8}\nTotal programs: {len(all_sources)}")
    else:
        print("\nNo IPTV sources found")

if __name__ == "__main__":
    main()
