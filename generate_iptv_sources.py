#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
generate_iptv_sources.py
æ•´åˆ IPTV è„šæœ¬ï¼šæŒ‰èŠ‚ç›®åˆ†ç±»ã€å¤šæºåˆå¹¶ã€IPè¿è¥å•†/åœ°åŒºå¤‡æ³¨ã€è¯·æ±‚è¶…æ—¶è·³è¿‡
"""

import requests
import os
import json
import time

# è¾“å…¥ IP æ–‡ä»¶
IP_FILE = os.path.join("dey/ip.txt")
# è¾“å‡º IPTV æºæ–‡ä»¶ï¼ˆæ™®é€šæ–‡æœ¬ï¼‰
OUTPUT_FILE = "iptv_sources.txt"
# è¾“å‡º IPTV M3U8 æ–‡ä»¶ï¼ˆå¯ç›´æ¥å¯¼å…¥æ’­æ”¾å™¨ï¼‰
OUTPUT_M3U8 = "iptv_sources.m3u"

# IPTV è¯·æ±‚è·¯å¾„
REQUEST_PATH = "/iptv/live/1000.json?key=txiptv"
TIMEOUT = 15  # è¯·æ±‚è¶…æ—¶ç§’æ•°
RETRY = 2     # è¯·æ±‚å¤±è´¥é‡è¯•æ¬¡æ•°
DELAY = 1     # æ¯æ¬¡è¯·æ±‚å»¶è¿Ÿç§’æ•°ï¼Œé¿å…è¢«å°

# -------------------èŠ‚ç›®åˆ†ç±»-------------------
PROGRAM_CATEGORIES = {
    "å¤®è§†é¢‘é“": [
        "CCTV-1","CCTV1","CCTV-01","CCTV-2","CCTV-3","CCTV-4","CCTV-5","CCTV-5+","CCTV-6","CCTV-7",
        "CCTV-8","CCTV-9","CCTV-10","CCTV-11","CCTV-12","CCTV-13","CCTV-14","CCTV-15","CCTV-16","CCTV-17",
        "CETV-1","CETV-2","CETV-3","CETV-4"
    ],
    "å«è§†é¢‘é“": [
        "å¹¿ä¸œå«è§†","é¦™æ¸¯å«è§†","æµ™æ±Ÿå«è§†","æ¹–å—å«è§†","åŒ—äº¬å«è§†","æ¹–åŒ—å«è§†","é»‘é¾™æ±Ÿå«è§†","å®‰å¾½å«è§†",
        "é‡åº†å«è§†","ä¸œæ–¹å«è§†","ä¸œå—å«è§†","ç”˜è‚ƒå«è§†","å¹¿è¥¿å«è§†","è´µå·å«è§†","æµ·å—å«è§†","æ²³åŒ—å«è§†",
        "æ²³å—å«è§†","å‰æ—å«è§†","æ±Ÿè‹å«è§†","æ±Ÿè¥¿å«è§†","è¾½å®å«è§†","å†…è’™å¤å«è§†","å®å¤å«è§†","é’æµ·å«è§†",
        "å±±ä¸œå«è§†","å±±è¥¿å«è§†","é™•è¥¿å«è§†","å››å·å«è§†","æ·±åœ³å«è§†","ä¸‰æ²™å«è§†","å¤©æ´¥å«è§†","è¥¿è—å«è§†",
        "æ–°ç–†å«è§†","äº‘å—å«è§†"
    ],
    "å¹¿ä¸œé¢‘é“": [
        "å¹¿ä¸œç æ±Ÿ","å¹¿ä¸œä½“è‚²","å¹¿ä¸œæ–°é—»","å¹¿ä¸œå«è§†","å¹¿ä¸œæ°‘ç”Ÿ","å¤§æ¹¾åŒºå«è§†","å¹¿å·ç»¼åˆ",
        "å¹¿å·å½±è§†","å¹¿å·ç«èµ›","æ±Ÿé—¨ç»¼åˆ","æ±Ÿé—¨ä¾¨ä¹¡ç”Ÿæ´»","ä½›å±±ç»¼åˆ","æ·±åœ³å«è§†","æ±•å¤´ç»¼åˆ",
        "æ±•å¤´ç»æµ","æ±•å¤´æ–‡æ—…","èŒ‚åç»¼åˆ","èŒ‚åå…¬å…±"
    ],
    "æµ™æ±Ÿé¢‘é“": [
        "æµ™æ±Ÿé’±æ±Ÿ","æµ™æ±Ÿé’±æ±Ÿéƒ½å¸‚","æµ™æ±Ÿé’±æ±Ÿå°","æµ™æ±Ÿç”Ÿæ´»","æµ™æ±Ÿç»æµç”Ÿæ´»","æµ™æ±Ÿæ•™è‚²","æµ™æ±Ÿæ°‘ç”Ÿ",
        "æµ™æ±Ÿæ–°é—»","æµ™æ±Ÿå°‘å„¿"
    ],
    "åŒ—äº¬é¢‘é“": [
        "åŒ—äº¬å¡é…·å°‘å„¿","åŒ—äº¬å½±é™¢","åŒ—äº¬æ–°é—»","åŒ—äº¬ç”Ÿæ´»","åŒ—äº¬ç§‘æ•™","åŒ—äº¬è´¢ç»","åŒ—äº¬é’å¹´",
        "BTVçºªå®","æ¸…åå¤§å­¦ç”µè§†å°","çŸ³æ™¯å±±æœ‰çº¿","é€šå·ç”µè§†å°"
    ],
    "è¾½å®é¢‘é“": [
        "æœé˜³æ•™è‚²","æœé˜³æ–°é—»ç»¼åˆ","è¾½å®åŒ—æ–¹","è¾½å®å½±è§†å‰§","è¾½å®æ•™è‚²é’å°‘","è¾½å®ç”Ÿæ´»",
        "è¾½å®ç»æµ","è¾½å®éƒ½å¸‚","é”¦å·ä¸€å¥—æ–°é—»ç»¼åˆ","é”¦å·äºŒå¥—æ•™è‚²"
    ],
    "æ¹–å—é¢‘é“": [
        "æ¹–å—éƒ½å¸‚","æ¹–å—è§†å‰§","æ¹–å—ç»è§†","æ¹–å—ç”µè§†å‰§","æ¹–å—ç”µå½±","æ¹–å—çˆ±æ™š","æ¹–å—æ•™è‚²",
        "æ¹–å—å¨±ä¹","æ¹–å—å›½é™…","æ¹–å—å…¬å…±","é‡‘é¹°çºªå®","æ¹–å—é‡‘é¹°çºªå®","é•¿æ²™æ–°é—»ç»¼åˆ","é•¿æ²™æ–°é—»",
        "é•¿æ²™æ”¿æ³•","é•¿æ²™å½±è§†","é•¿æ²™å¥³æ€§","é†´é™µç»¼åˆ","è¡¡é˜³æ–°é—»ç»¼åˆ","è¡¡é˜³å…¬å…±","èŒ¶é™µæ–°é—»ç»¼åˆ",
        "ç›Šé˜³æ–°é—»ç»¼åˆ","ç›Šé˜³æ•™è‚²","ç›Šé˜³å…¬å…±","æ¹˜æ½­æ–°é—»ç»¼åˆ","æ¹˜æ½­å¿ç»¼åˆ","æ¹˜æ½­å…¬å…±",
        "æ¹˜æ½­å…¬å…±éƒ½å¸‚","æ´ªæ±Ÿå¸‚ç»¼åˆ","æ³¸æºªç”µè§†å°","æ±¨ç½—æ–°é—»ç»¼åˆ","æ±Ÿåç»¼åˆ","æ±åŸç»¼åˆ",
        "æ°¸é¡ºç»¼åˆ","æ¡‘æ¤æ–°é—»ç»¼åˆ","æ–°åŒ–æ–°é—»ç»¼åˆ","å±ˆåŸç»¼åˆ","å®ä¹¡ç»¼åˆ","å¨„åº•ç»¼åˆ","ä¿é–æ—¶æ”¿",
        "äº‘æºªæ–°é—»ç»¼åˆ"
    ],
    "æ¹–åŒ—é¢‘é“": [
        "æ¹–åŒ—æ–°é—»ç»¼åˆ","æ¹–åŒ—ç»¼åˆ","æ¹–åŒ—ç»è§†","æ¹–åŒ—ç”Ÿæ´»","æ¹–åŒ—æ•™è‚²","æ¹–åŒ—å½±è§†","æ¹–åŒ—å…¬å…±æ–°é—»",
        "æ¹–åŒ—å…¬å…±","æ¹–åŒ—ç»æµ","æ¹–åŒ—å„ä¸Š","æ­¦æ±‰ä¸€å°æ–°é—»ç»¼åˆ","æ­¦æ±‰äºŒå°ç”µè§†å‰§","æ­¦æ±‰ä¸‰å°ç§‘æŠ€ç”Ÿæ´»",
        "æ­¦æ±‰å››å°ç»æµ","æ­¦æ±‰äº”å°æ–‡ä½“","æ­¦æ±‰å…­å°å¤–è¯­","æ­¦æ±‰1æ–°é—»ç»¼åˆ","æ­¦æ±‰2ç”µè§†å‰§",
        "æ­¦æ±‰3ç§‘æŠ€ç”Ÿæ´»","æ­¦æ±‰æ•™è‚²","æ¹–åŒ—æ­¦æ±‰æ•™è‚²","æ­¦æ±‰ç»æµ","æ­¦æ±‰æ–°é—»ç»¼åˆ","æ­¦æ±‰æ–‡ä½“",
        "æ­¦æ±‰å¤–è¯­","æ±Ÿå¤ç»æµç”Ÿæ´»","æ±Ÿå¤æ–°é—»ç»¼åˆ","å»ºå§‹ç»¼åˆ","å´‡é˜³æ–°é—»ç»¼åˆ","åå °æ–°é—»",
        "åå °å…¬å…±","ä¿åº·æ–°é—»ç»¼åˆ","ä»™æ¡ƒç”Ÿæ´»æ–‡ä½“","ä»™æ¡ƒæ–°é—»ç»¼åˆ","éº»åŸç»¼åˆ","éƒ§é˜³æ–°é—»ç»¼åˆ",
        "è†é—¨æ–°é—»ç»¼åˆ","äº‘æ¢¦ç»¼åˆ","äº‘æ¢¦å…šå»ºå†œä¸š","æ­¦æ±‰ç”Ÿæ´»","æ­¦æ±‰æ–°é—»","æ­¦æ±‰ç»æµ",
        "è†é—¨æ–°é—»ç»¼åˆ","å´‡é˜³ç»¼åˆ","åå °æ–°é—»","æ½œæ±Ÿç»¼åˆ","æ¹–åŒ—ç”Ÿæ´»","æ¹–åŒ—æ•™è‚²",
        "æ¹–åŒ—å½±è§†","æ¹–åŒ—å„ä¸Š"
    ],
    "å¹¿è¥¿é¢‘é“": [
        "ä¹ä¸šç»¼åˆ","å‡Œäº‘ç»¼åˆ","å‡­ç¥¥ç»¼åˆ","åŒ—æµ·æ–°é—»ç»¼åˆ","åŒ—æµ·ç»æµç§‘æ•™","å—å®å…¬å…±","å—å®å½±å¨±ä¹",
        "å—å®æ–°é—»ç»¼åˆ","å—å®éƒ½å¸‚ç”Ÿæ´»","åšç™½ç»¼åˆ","å¤©ç­‰ç»¼åˆ","å®¾é˜³ç»¼åˆ","å²‘æºªç»¼åˆ","å´‡å·¦ç»¼åˆ",
        "å·´é©¬ç»¼åˆ","æ˜­å¹³ç»¼åˆ","æ¥å®¾ç»¼åˆ","æ¡‚å¹³ç»¼åˆ","çŒé˜³æ–°é—»ç»¼åˆ","çµå·ç»¼åˆ","ç”°ä¸œç»¼åˆ",
        "ç”°é˜³ç»¼åˆ","ç½—åŸç»¼åˆ","èæ°´ç»¼åˆ","è¥¿æ—ç»¼åˆ","è´ºå·ç»¼åˆ","èµ„æºç”µè§†å°","é‚£å¡ç»¼åˆ",
        "éƒ½å®‰ç»¼åˆ","é’¦å·å…¬å…±","é’¦å·ç»¼åˆ","é–è¥¿ç»¼åˆ","é¾™å·ç»¼åˆ","å¹¿è¥¿æ–°é—»","ç½—åŸç»¼åˆ",
        "åŒ—æµ·æ–°é—»","æ¡‚æ—æ–°é—»","å¹¿è¥¿è´ºå·","å¹¿è¥¿å›½é™…","å¹¿è¥¿ä¹æ€è´­","å—å®æ–°é—»ç»¼åˆ",
        "å—å®éƒ½å¸‚ç”Ÿæ´»","å—å®å½±è§†å¨±ä¹","å—å®å…¬å…±"
    ],
    "å¤©æ´¥é¢‘é“": [
        "å®æ²³æ–°é—»","æ»¨æµ·æ–°é—»","æ»¨æµ·ç»¼è‰º","æ»¨æµ·å½±é™¢","æ´¥å—ä¸€å¥—","æ­¦æ¸…ç»¼åˆ","å¤©æ´¥éƒ½å¸‚","å¤©æ´¥æ–°é—»",
        "å¤©æ´¥æ–‡è‰º","å¤©æ´¥å«è§†"
    ],
    "ç¦å»ºé¢‘é“": [
        "ä¸‰æ˜å…¬å…±","ä¸‰æ˜æ–°é—»ç»¼åˆ","äº‘éœ„ç»¼åˆ","å¦é—¨å«è§†","å®åŒ–ç”µè§†ä¸€å¥—","å°†ä¹ç»¼åˆ","å»ºå®ç»¼åˆ",
        "å¾·åŒ–æ–°é—»ç»¼åˆ","æ–°ç½—ç”µè§†ä¸€å¥—","æ™‹æ±Ÿç”µè§†å°","æ°¸å®‰ç»¼åˆ","æ°¸æ³°ç»¼åˆ","æ³°å®æ–°é—»","æ¼³å·æ–°é—»ç»¼åˆ",
        "æ¼³æµ¦ç»¼åˆ","çŸ³ç‹®ç»¼åˆ","ç¦å·å°‘å„¿","ç¦å·å½±é™¢","ç¦å·ç”Ÿæ´»","ç¦å·ç»¼åˆ","éœæµ¦ç»¼åˆ","é¾™å²©å…¬å…±",
        "é¾™å²©æ–°é—»ç»¼åˆ","ç¦å»ºæ–‡ä½“","ç¦å»ºæ–°é—»","ç¦å»ºç”µè§†å‰§","ç¦å»ºç»æµ","ç¦å»ºç»¼åˆ","ç¦å»ºå…¬å…±",
        "ç¦å»ºç”µè§†å‰§","ç¦å»ºæ—…æ¸¸","ç¦å»ºç»è§†","ç¦å»ºä½“è‚²","ç¦å»ºå°‘å„¿","ç¦å»ºæµ·å³¡å«è§†",
        "äº‘éœ„ç»¼åˆ","å»ºå®ç»¼åˆ","æ¼³å·æ–°é—»","é¾™å²©å…¬å…±","é¾™å²©ç»¼åˆ"
    ],
    "æ¸¯æ¾³å°é¢‘é“": [
        "ç¿¡ç¿ å°","æ˜ç å°","å‡¤å‡°ä¸­æ–‡","å‡¤å‡°èµ„è®¯","å‡¤å‡°é¦™æ¸¯","å‡¤å‡°å«è§†","TVBSäºšæ´²","é¦™æ¸¯å«è§†",
        "çº¬æ¥ä½“è‚²","çº¬æ¥è‚²ä¹","J2","Viutv","ä¸‰ç«‹å°æ¹¾","æ— çº¿æ–°é—»","ä¸‰ç«‹æ–°é—»","ä¸œæ£®ç»¼åˆ",
        "ä¸œæ£®è¶…è§†","ä¸œæ£®ç”µå½±","Nowå‰§é›†","Nowåå‰§","é–å¤©èµ„è®¯","æ˜Ÿå«å¨±ä¹","å«è§†å¡å¼"
    ],
    "ç”µå½±é¢‘é“": [
        "CHCå®¶åº­å½±é™¢","CHCåŠ¨ä½œç”µå½±","CHCé«˜æ¸…ç”µå½±","æ·˜å‰§åœº","æ·˜å¨±ä¹","æ·˜ç”µå½±","NewTVæƒŠæ‚šæ‚¬ç–‘",
        "NewTVåŠ¨ä½œç”µå½±","é»‘è“ç”µå½±","çº¬æ¥ç”µå½±","é–å¤©æ˜ ç”»","é–å¤©æˆå‰§","æ˜Ÿå«å¨±ä¹","è‰¾å°”è¾¾å¨±ä¹",
        "ç»å…¸ç”µå½±","IPTVç»å…¸ç”µå½±","å¤©æ˜ ç»å…¸","æ— çº¿æ˜Ÿæ²³","æ˜Ÿç©ºå«è§†","ç§äººå½±é™¢","ä¸œæ£®ç”µå½±",
        "é¾™ç¥¥ç”µå½±","ä¸œæ£®æ´‹ç‰‡","ä¸œæ£®è¶…è§†"
    ],
    "å’ªå’•ç›´æ’­": [
        f"å’ªå’•ç›´æ’­{i}" for i in range(1,46)
    ],
    "åŠ¨ç”»é¢‘é“": [
        "å°‘å„¿åŠ¨ç”»","å¡é…·åŠ¨ç”»","åŠ¨æ¼«ç§€åœº","æ–°åŠ¨æ¼«","é’æ˜¥åŠ¨æ¼«","çˆ±åŠ¨æ¼«","ä¸­å½•åŠ¨æ¼«","å®å®åŠ¨ç”»",
        "CNå¡é€š","ä¼˜æ¼«å¡é€š","é‡‘é¹°å¡é€š","ç›å½©å°‘å„¿","é»‘è“åŠ¨ç”»","ç‚«åŠ¨å¡é€š","24Hå›½æ¼«çƒ­æ’­",
        "æµ™æ±Ÿå°‘å„¿","æ²³åŒ—å°‘å„¿ç§‘æ•™","ä¸ƒé¾™ç ","ç«å½±å¿è€…","æµ·ç»µå®å®","ä¸­åå°å½“å®¶","æ–—ç ´è‹ç©¹ç„å¹»å‰§",
        "çŒ«å’Œè€é¼ ","ç»å…¸åŠ¨æ¼«","èœ¡ç¬”å°æ–°","æ¼«ç”»è§£è¯´"
    ],
    "ç»å…¸å‰§åœº": [
        "ç¬‘å‚²æ±Ÿæ¹–","å¤©é¾™å…«éƒ¨","é¹¿é¼è®°","ä»™å‰‘å¥‡ä¾ ä¼ ","è¥¿æ¸¸è®°","ä¸‰å›½æ¼”ä¹‰","æ°´æµ’ä¼ ",
        "æ–°ç™½å¨˜å­ä¼ å¥‡","å¤©é¾™å…«éƒ¨","æµå…¬æ¸¸è®°","å°ç¥æ¦œ","é—¯å…³ä¸œ","ä¸Šæµ·æ»©","å°„é›•è‹±é›„ä¼ "
    ]
}

# -------------------è¯»å– IP åˆ—è¡¨-------------------
def read_ip_list(file_path):
    if not os.path.exists(file_path):
        raise FileNotFoundError(f"IP æ–‡ä»¶ä¸å­˜åœ¨: {file_path}")
    with open(file_path, "r", encoding="utf-8") as f:
        return [line.strip() for line in f if line.strip()]

# -------------------è·å– IP ä¿¡æ¯ï¼ˆåœ°åŒº+è¿è¥å•†ï¼‰-------------------
def get_ip_info(ip):
    try:
        resp = requests.get(f"https://ipinfo.io/{ip}/json", timeout=5)
        data = resp.json()
        city = data.get("city","æœªçŸ¥")
        org = data.get("org","æœªçŸ¥")
        return f"{city},{org}"
    except:
        return "æœªçŸ¥,æœªçŸ¥"

# -------------------è¯·æ±‚ IPTV JSON-------------------
def fetch_json(ipport):
    url = f"http://{ipport}{REQUEST_PATH}"
    for attempt in range(RETRY+1):
        try:
            resp = requests.get(url, timeout=TIMEOUT)
            resp.raise_for_status()
            return resp.json()
        except Exception as e:
            print(f"[é”™è¯¯] è¯·æ±‚å¤±è´¥: {url} -> {e} (é‡è¯• {attempt}/{RETRY})")
            time.sleep(DELAY)
    return None

# -------------------è§£æ JSON æ•°æ®-------------------
def parse_data(json_data, ipport, ip_info):
    sources = {}
    if not json_data or "data" not in json_data:
        return sources
    for item in json_data["data"]:
        name = item.get("name","æœªçŸ¥")
        url_path = item.get("url","")
        if url_path:
            full_url = f"http://{ipport}{url_path} ({ip_info})"
            if name not in sources:
                sources[name] = [full_url]
            else:
                sources[name].append(full_url)
    return sources

# -------------------åˆå¹¶å¤š IP çš„æº-------------------
def merge_sources(all_sources, new_sources):
    for name, urls in new_sources.items():
        if name not in all_sources:
            all_sources[name] = urls
        else:
            all_sources[name].extend(urls)

# -------------------ä¿å­˜æ™®é€šæ–‡æœ¬-------------------
def save_txt(all_sources, file_path):
    with open(file_path,"w",encoding="utf-8") as f:
        for category, names in PROGRAM_CATEGORIES.items():
            f.write(f"ğŸ“º{category},#genre#\n")
            for name in names:
                if name in all_sources:
                    for url in all_sources[name]:
                        f.write(f"{name},{url}\n")

# -------------------ä¿å­˜ M3U8 æ’­æ”¾åˆ—è¡¨-------------------
def save_m3u(all_sources, file_path):
    with open(file_path,"w",encoding="utf-8") as f:
        f.write("#EXTM3U\n")
        for category, names in PROGRAM_CATEGORIES.items():
            for name in names:
                if name in all_sources:
                    urls = all_sources[name]
                    for i, url in enumerate(urls):
                        f.write(f"#EXTINF:-1,{name} [æº{i+1}]\n{url}\n")

# -------------------ä¸»ç¨‹åº-------------------
def main():
    try:
        ip_list = read_ip_list(IP_FILE)
    except Exception as e:
        print(f"[é”™è¯¯] {e}")
        return

    all_sources = {}

    for ipport in ip_list:
        ip = ipport.split(":")[0]
        ip_info = get_ip_info(ip)
        print(f"æ­£åœ¨è¯·æ±‚ï¼š{ipport} ({ip_info})")
        json_data = fetch_json(ipport)
        sources = parse_data(json_data, ipport, ip_info)
        if sources:
            merge_sources(all_sources, sources)
            print(f"[æç¤º] è·å–åˆ° {len(sources)} æ¡èŠ‚ç›®")
        else:
            print(f"[æç¤º] æœªè·å–åˆ°æ•°æ®: {ipport}")

    if all_sources:
        save_txt(all_sources, OUTPUT_FILE)
        save_m3u(all_sources, OUTPUT_M3U8)
        print(f"\nâœ… å…¨éƒ¨å®Œæˆï¼Œç”Ÿæˆæ–‡ä»¶ï¼š\n- {OUTPUT_FILE}ï¼ˆæ–‡æœ¬ï¼‰\n- {OUTPUT_M3U8}ï¼ˆM3U8 æ’­æ”¾åˆ—è¡¨ï¼‰")
        print(f"å…± {len(all_sources)} ä¸ªèŠ‚ç›®")
    else:
        print("\nâš ï¸ æœªè·å–åˆ°ä»»ä½• IPTV æº")

if __name__ == "__main__":
    main()
